<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="link-data" content="https://kvnchpl.github.io/substation/substation.json">
        <title>substation</title>
        <link rel="stylesheet" href="https://kvnchpl.github.io/main/main.css">
    </head>
    <body>
        <div id="image-overlay" data-images=""></div>
        <section id="link-container"></section>
        <script>
            const BASE_URL = "https://kvnchpl.github.io/main/";
            const IMAGE_LIST_URL = "https://kvnchpl.github.io/main/sky_images.json";
            const isMobile = () => window.innerWidth <= 768;

            window.onload = () => {
                const BASE_URL = "https://kvnchpl.github.io/main/";
                const IMAGE_LIST_URL = "https://kvnchpl.github.io/main/sky_images.json";
                const isMobile = () => window.innerWidth <= 768;
                const linkContainer = document.getElementById('link-container'); // Defined globally for use throughout

                const metaLinkList = document.querySelector('meta[name="link-data"]');
                const jsonUrl = metaLinkList ? metaLinkList.getAttribute('content') : null;

                if (!jsonUrl) {
                    console.error("No JSON URL found in the <meta> tag with name='link-data'.");
                    return;
                }

                // Fetch and handle sky_images.json
                fetch(IMAGE_LIST_URL)
                    .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch images');
                    }
                    return response.json(); // Returns the array directly
                })
                    .then(imageList => {
                    console.log("Data successfully parsed from JSON: ", imageList);
                    initializeImageOverlay(imageList); // Handle image logic
                })
                    .catch(error => console.error('Error loading images:', error));

                // Function to initialize image overlay
                function initializeImageOverlay(imageList) {
                    let shuffledImages = [];
                    let currentImageIndex = 0;

                    const shuffleArray = (array) => array.sort(() => Math.random() - 0.5);

                    const getNextImage = () => {
                        const nextImage = shuffledImages[currentImageIndex];
                        currentImageIndex = (currentImageIndex + 1) % shuffledImages.length;
                        return nextImage;
                    };

                    shuffledImages = shuffleArray([...imageList]);

                    if (isMobile()) {
                        const overlay = document.getElementById('image-overlay');
                        const initialImage = getNextImage();
                        overlay.style.backgroundImage = `url(${initialImage})`;
                        overlay.style.opacity = '0.5';

                        document.addEventListener('click', (event) => {
                            const target = event.target;

                            // Allow links to navigate
                            if (target.closest('a')) {
                                console.log('Link clicked:', target.closest('a').href);
                                return; // Let the link handle navigation
                            }

                            // Otherwise, cycle the image
                            const nextImage = getNextImage();
                            overlay.style.backgroundImage = `url(${nextImage})`;
                        });
                    }
                }

                // Function to fetch and handle link data
                function loadLinks() {
                    fetch(jsonUrl)
                        .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to fetch JSON from ${jsonUrl}`);
                        }
                        return response.json();
                    })
                        .then(data => {
                        console.log("Data successfully parsed from JSON:", data);
                        renderLinks(data);

                        // Run hover and randomize logic after links are rendered
                        const rows = document.querySelectorAll('#link-container .row');
                        const debounceTime = 200; // Adjust as needed
                        const initialPositions = randomizeLinks(rows); // Randomize link positions
                        enableHoverEffect(rows, initialPositions, debounceTime); // Enable hover effects
                    })
                        .catch(error => console.error("Error loading link list:", error));
                }

                // Function to render the links
                function renderLinks(data) {
                    if (!data || !Array.isArray(data) || data.length === 0) {
                        console.error("Invalid or empty data for rendering links:", data);
                        return;
                    }

                    const monthNames = [
                        "January", "February", "March", "April", "May", "June",
                        "July", "August", "September", "October", "November", "December"
                    ];

                    data.forEach(item => {
                        console.log("Processing item:", item);

                        const row = document.createElement("div");
                        row.classList.add("row");

                        const linkWrapper = document.createElement("div");
                        linkWrapper.classList.add("link-wrapper");

                        const link = document.createElement("a");
                        link.href = item.href;
                        link.textContent = item.label;
                        link.setAttribute("aria-label", item.label);

                        const isExternal = link.href.startsWith("http") && !link.href.includes(window.location.hostname);
                        const openInNewTab = item.newTab !== undefined ? item.newTab : isExternal;

                        if (openInNewTab) {
                            link.setAttribute("target", "_blank");
                            link.setAttribute("rel", "noopener noreferrer");
                        }

                        const subtitleParts = [];
                        if (item.author) subtitleParts.push(`By ${item.author}`);
                        if (item.publication) subtitleParts.push(item.publication);

                        let monthAndYear = "";
                        if (item.publication_month) {
                            const month = typeof item.publication_month === "number"
                            ? monthNames[item.publication_month - 1]
                            : item.publication_month;
                            monthAndYear = month;
                        }
                        if (item.publication_year) {
                            monthAndYear += ` ${item.publication_year}`;
                        }

                        if (monthAndYear) subtitleParts.push(monthAndYear);

                        const subtitleText = subtitleParts.join(", ");
                        if (subtitleText) {
                            const subtitle = document.createElement("span");
                            subtitle.classList.add("subtitle");
                            subtitle.textContent = subtitleText;
                            linkWrapper.appendChild(subtitle);
                        }

                        linkWrapper.appendChild(link);
                        row.appendChild(linkWrapper);
                        linkContainer.appendChild(row);
                    });

                    console.log("Links rendered successfully.");
                }

                // Original randomizeLinks function
                function randomizeLinks(rows) {
                    const initialPositions = [];
                    rows.forEach(row => {
                        const x = Math.random() * 100 - 50; // X-axis random position
                        const y = Math.random() * 100 - 50; // Y-axis random position
                        initialPositions.push({ x, y });
                        row.style.transform = `translate(${x}px, ${y}px)`;
                    });
                    return initialPositions;
                }

                // Original enableHoverEffect function
                function enableHoverEffect(rows, initialPositions, debounceTime) {
                    rows.forEach((row, index) => {
                        row.addEventListener('mouseenter', () => {
                            row.style.transform = 'translate(0, 0)'; // Reset to original position on hover
                        });

                        row.addEventListener('mouseleave', () => {
                            setTimeout(() => {
                                const { x, y } = initialPositions[index];
                                row.style.transform = `translate(${x}px, ${y}px)`; // Restore random position
                            }, debounceTime);
                        });
                    });
                }

                loadLinks(); // Trigger fetching and rendering of links

                linkContainer.style.visibility = 'visible';
                linkContainer.style.opacity = '1';
            };
        </script>
        <!-- <script src="https://kvnchpl.github.io/main/main.js"></script> -->
    </body>
</html>